<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ranking Vol√∫menes Textiles - Nettalco</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* --- VARIABLES CSS --- */
:root {
    --primary: #4318FF;
    --primary-light: #868CFF;
    --primary-dark: #2B3674;
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --bg-body: #F4F7FE;
    --surface: #FFFFFF;
    --card-bg: rgba(255, 255, 255, 0.65);
    --card-border: rgba(255, 255, 255, 0.8);
    --text-main: #1e293b;
    --text-dark: #2B3674;
    --text-sec: #64748b;
    --text-light: #A3AED0;
    --border: #E0E5F2;
    --input-bg: rgba(255, 255, 255, 0.6);
    --shadow-card: 0px 18px 40px rgba(112, 144, 176, 0.12);
    --shadow-soft: 0 10px 30px rgba(0,0,0,0.05);
    --radius: 20px;
    --radius-sm: 12px;
    --radius-xs: 8px;
}

/* --- RESET --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; line-height: 1.6; -webkit-font-smoothing: antialiased; }

/* --- FONDO AURORA --- */
.aurora-bg { position: relative; overflow-x: hidden; }
.aurora-bg::before, .aurora-bg::after { content: ''; position: fixed; width: 600px; height: 600px; border-radius: 50%; filter: blur(90px); z-index: -1; opacity: 0.5; animation: auroraFloat 10s infinite ease-in-out alternate; pointer-events: none; }
.aurora-bg::before { background: #60a5fa; top: -10%; left: -10%; }
.aurora-bg::after { background: #c084fc; bottom: -10%; right: -10%; animation-delay: -5s; }
@keyframes auroraFloat { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 50px) scale(1.1); } }

/* --- TIPOGRAFIA --- */
h1, h2, h3 { font-weight: 700; color: var(--text-dark); line-height: 1.3; }
.gradient-title { background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

/* --- CARDS --- */
.card { background: var(--surface); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow-card); border: 1px solid rgba(255,255,255,0.5); }
.glass-card { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: var(--radius); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: var(--shadow-soft); }

/* --- BOTONES --- */
.btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none; border: none; outline: none; }
.btn-accent { background: var(--accent); color: white; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.2); }
.btn-accent:hover { background: var(--accent-hover); transform: translateY(-2px); }
.btn-secondary { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
.btn-secondary:hover { background: #f8f9fa; border-color: var(--text-light); }

/* --- FORMULARIOS --- */
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-label { font-size: 0.8rem; font-weight: 600; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }
.form-select { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-xs); font-size: 0.9rem; color: var(--text-main); background: var(--input-bg); transition: all 0.2s ease; outline: none; }
.form-select:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

/* --- UTILIDADES --- */
.text-muted { color: var(--text-sec); }
.text-sm { font-size: 0.85rem; }
.hidden { display: none !important; }

/* --- SPINNER --- */
.spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 16px; z-index: 9999; }

/* --- LAYOUT --- */
.container { max-width: 1200px; margin: 0 auto; padding: 0 20px 40px; }

/* --- HEADER --- */
.site-header { position: sticky; top: 0; z-index: 100; padding: 16px 30px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
.header-left { display: flex; align-items: center; gap: 16px; }
.header-logo { height: 45px; object-fit: contain; }
.header-left h1 { font-size: 1.5rem; margin: 0; }
.header-left p { margin: 0; }
.header-right { text-align: right; }

/* --- SELECTOR DE VISTA (TABS HERO) --- */
.view-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px; }

.view-btn {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 8px; padding: 28px 20px; border-radius: var(--radius); cursor: pointer;
    border: 2px solid var(--border); background: var(--surface);
    transition: all 0.3s ease; position: relative; overflow: hidden;
}
.view-btn::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(67,24,255,0.05));
    opacity: 0; transition: opacity 0.3s;
}
.view-btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(59, 130, 246, 0.15); border-color: var(--accent); }
.view-btn:hover::before { opacity: 1; }

.view-btn.active {
    border-color: var(--accent); background: linear-gradient(135deg, #3b82f6, #4318FF);
    box-shadow: 0 8px 25px rgba(59, 130, 246, 0.35);
}
.view-btn.active::before { opacity: 0; }
.view-btn.active .view-icon,
.view-btn.active .view-label,
.view-btn.active .view-count { color: white; -webkit-text-fill-color: white; }

.view-icon { font-size: 2.2rem; line-height: 1; }
.view-label { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); transition: color 0.3s; }
.view-count { font-size: 0.82rem; font-weight: 600; color: var(--text-sec); transition: color 0.3s; }

/* --- FILTROS --- */
.filter-bar { padding: 16px 24px; margin-bottom: 24px; }
.filter-row { display: flex; align-items: flex-end; gap: 16px; flex-wrap: wrap; }
.filter-actions { display: flex; gap: 8px; padding-bottom: 2px; }

/* --- RANKING --- */
.ranking-section { margin-bottom: 24px; }
.ranking-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.ranking-header h2 { font-size: 1.15rem; display: flex; align-items: center; gap: 10px; }
.ranking-table { width: 100%; min-height: 100px; }

.rank-row { display: flex; align-items: center; padding: 12px 16px; border-radius: var(--radius-sm); margin-bottom: 8px; background: rgba(248, 250, 252, 0.6); transition: all 0.2s; gap: 16px; }
.rank-row:hover { background: rgba(59, 130, 246, 0.05); transform: translateX(4px); }

.rank-pos { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.85rem; flex-shrink: 0; background: #F4F7FE; color: var(--text-light); }
.rank-pos.pos-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; box-shadow: 0 4px 12px rgba(255, 183, 71, 0.4); }
.rank-pos.pos-2 { background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: white; box-shadow: 0 4px 12px rgba(163, 174, 208, 0.3); }
.rank-pos.pos-3 { background: linear-gradient(135deg, #CD7F32, #B87333); color: white; box-shadow: 0 4px 12px rgba(205, 127, 50, 0.3); }

.rank-name { flex: 1; font-weight: 600; font-size: 0.95rem; color: var(--text-main); min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.rank-desc { display: block; font-size: 0.78rem; font-weight: 400; color: var(--text-sec); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- FOOTER --- */
.site-footer { text-align: center; padding: 24px; color: var(--text-sec); font-size: 0.85rem; margin-top: 20px; }

/* --- EMPTY STATE --- */
.empty-state { text-align: center; padding: 40px 20px; color: var(--text-sec); }
.empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; }

/* --- RESPONSIVE TABLET --- */
@media (max-width: 768px) {
    :root { --radius: 16px; --radius-sm: 10px; }
    .container { padding: 0 14px 30px; }
    .site-header { position: relative; flex-direction: row; padding: 10px 14px; margin-bottom: 14px; gap: 8px; }
    .header-left { flex-direction: row; gap: 10px; }
    .header-logo { height: 28px; }
    .header-left h1 { font-size: 0.95rem; }
    .header-left p { display: none; }
    .header-right { text-align: right; font-size: 0.72rem; }
    .view-selector { gap: 12px; margin-bottom: 16px; }
    .view-btn { padding: 20px 14px; gap: 6px; }
    .view-icon { font-size: 1.8rem; }
    .view-label { font-size: 0.95rem; }
    .view-count { font-size: 0.75rem; }
    .filter-bar { padding: 14px 16px; margin-bottom: 16px; }
    .filter-row { flex-direction: column; align-items: stretch; gap: 12px; }
    .filter-actions { justify-content: center; }
    .btn { padding: 10px 20px; font-size: 0.9rem; min-height: 44px; }
    .form-select { padding: 10px 12px; font-size: 1rem; min-height: 44px; }
    .ranking-section { margin-bottom: 0; }
    .ranking-header { margin-bottom: 10px; }
    .ranking-header h2 { font-size: 1rem; }
    .card { padding: 14px; }
    .ranking-table { min-height: auto; }
    .rank-row { padding: 10px 12px; gap: 10px; margin-bottom: 4px; }
    .rank-pos { width: 28px; height: 28px; font-size: 0.75rem; }
    .rank-name { font-size: 0.84rem; white-space: normal; line-height: 1.3; }
    .rank-desc { font-size: 0.72rem; white-space: normal; }
    .site-footer { padding: 16px; font-size: 0.78rem; margin-top: 10px; }
    .empty-state { padding: 24px 16px; }
    .empty-state .empty-icon { font-size: 2rem; }
    .aurora-bg::before, .aurora-bg::after { width: 300px; height: 300px; opacity: 0.3; }
}

/* --- RESPONSIVE MOVIL PEQUENO --- */
@media (max-width: 400px) {
    .container { padding: 0 8px 20px; }
    .site-header { padding: 8px 10px; margin-bottom: 10px; }
    .header-logo { height: 24px; }
    .header-left h1 { font-size: 0.85rem; }
    .header-left { gap: 8px; }
    .view-selector { gap: 8px; margin-bottom: 12px; }
    .view-btn { padding: 16px 10px; gap: 4px; border-radius: 12px; }
    .view-icon { font-size: 1.5rem; }
    .view-label { font-size: 0.85rem; }
    .view-count { font-size: 0.7rem; }
    .filter-bar { padding: 10px; margin-bottom: 10px; }
    .filter-row { gap: 10px; }
    .card { padding: 10px; }
    .rank-row { padding: 8px 10px; gap: 8px; margin-bottom: 3px; border-radius: 8px; }
    .rank-pos { width: 24px; height: 24px; font-size: 0.65rem; }
    .rank-pos.pos-1, .rank-pos.pos-2, .rank-pos.pos-3 { box-shadow: none; }
    .rank-name { font-size: 0.78rem; }
    .rank-desc { font-size: 0.66rem; }
    .ranking-header h2 { font-size: 0.85rem; gap: 6px; }
    .ranking-header { margin-bottom: 8px; }
}

@media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; } }

/* --- CONTROLES (SEARCH / SORT) --- */
.ranking-header { flex-wrap: wrap; gap: 8px; }
.rank-controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.rank-search {
    padding: 7px 12px; border: 1px solid var(--border); border-radius: var(--radius-xs);
    font-size: 0.84rem; color: var(--text-main); background: var(--input-bg);
    width: 150px; outline: none; transition: all 0.2s; font-family: inherit;
}
.rank-search:focus { border-color: var(--accent); background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); width: 180px; }
.rank-sort {
    padding: 7px 10px; border: 1px solid var(--border); border-radius: var(--radius-xs);
    font-size: 0.82rem; color: var(--text-main); background: var(--input-bg);
    outline: none; cursor: pointer; font-family: inherit; transition: all 0.2s;
}
.rank-sort:focus { border-color: var(--accent); background: white; }
.btn-expand-all {
    padding: 6px 12px; border-radius: var(--radius-xs); font-size: 0.78rem; font-weight: 600;
    border: 1px solid var(--border); background: var(--input-bg); color: var(--text-sec);
    cursor: pointer; font-family: inherit; transition: all 0.2s; white-space: nowrap;
}
.btn-expand-all:hover { background: white; border-color: var(--accent); color: var(--accent); }

/* === TARJETAS DE ART√çCULO === */
.art-card {
    border-radius: var(--radius-sm); margin-bottom: 8px;
    border: 1px solid var(--border); background: white;
    overflow: hidden; transition: box-shadow 0.2s, border-color 0.2s;
}
.art-card:hover { box-shadow: 0 2px 14px rgba(0,0,0,0.07); }
.art-card.expanded { border-color: #93c5fd; box-shadow: 0 4px 20px rgba(59,130,246,0.1); }

.art-header {
    display: flex; align-items: center; padding: 12px 14px; gap: 12px;
    cursor: pointer; -webkit-tap-highlight-color: transparent; user-select: none;
}
.art-header:active { background: rgba(0,0,0,0.02); }

.art-pos {
    width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 0.8rem; background: #F4F7FE; color: var(--text-light);
}
.art-pos.pos-1 { background: linear-gradient(135deg,#FFD700,#FFA500); color:white; box-shadow:0 3px 10px rgba(255,183,71,.4); }
.art-pos.pos-2 { background: linear-gradient(135deg,#C0C0C0,#A8A8A8); color:white; }
.art-pos.pos-3 { background: linear-gradient(135deg,#CD7F32,#B87333); color:white; }

.art-info { flex: 1; min-width: 0; }
.art-code  { font-size: 0.95rem; font-weight: 700; color: var(--text-dark); }
.art-desc  { font-size: 0.78rem; color: var(--text-sec); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.art-chips { display: flex; align-items: center; gap: 6px; margin-top: 5px; flex-wrap: wrap; }

.art-vol-chip {
    font-size: 0.72rem; font-weight: 600; color: var(--text-sec);
    background: #f1f5f9; padding: 2px 8px; border-radius: 20px;
}
.merma-badge {
    display: inline-flex; align-items: center; gap: 3px; padding: 3px 10px; border-radius: 20px;
    font-size: 0.74rem; font-weight: 800; white-space: nowrap;
}
.merma-low  { background: #dcfce7; color: #15803d; }
.merma-mid  { background: #ffedd5; color: #c2410c; }
.merma-high { background: #fee2e2; color: #b91c1c; }

.art-toggle { font-size: 0.8rem; color: var(--text-light); flex-shrink: 0; transition: transform 0.25s; }
.art-card.expanded .art-toggle { transform: rotate(180deg); color: var(--accent); }

/* --- Secci√≥n de detalle (colapsa/expande) --- */
.art-detail {
    display: none; border-top: 1px solid #e2e8f0;
    padding: 14px 14px 18px; background: #fafbfd;
}
.art-card.expanded .art-detail { display: block; }

/* KPIs del art√≠culo */
.art-kpi-row { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
.art-kpi { background: white; border-radius: var(--radius-xs); padding: 10px 8px; text-align: center; border: 1px solid #e2e8f0; }
.art-kpi-val { font-size: 1rem; font-weight: 800; color: var(--text-dark); line-height: 1.2; }
.art-kpi-val.warn   { color: #c2410c; }
.art-kpi-val.danger { color: #b91c1c; }
.art-kpi-label { font-size: 0.62rem; color: var(--text-sec); margin-top: 3px; text-transform: uppercase; letter-spacing: 0.4px; font-weight: 600; }

/* Barras de fallas */
.falla-section-title {
    font-size: 0.72rem; font-weight: 700; color: var(--text-sec);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px;
}
.falla-bar-item { margin-bottom: 14px; }
.falla-bar-item:last-child { margin-bottom: 0; }
.falla-bar-header { display: flex; justify-content: space-between; align-items: baseline; gap: 8px; margin-bottom: 5px; }
.falla-bar-name { font-size: 0.88rem; font-weight: 600; color: var(--text-main); flex: 1; line-height: 1.3; }
.falla-sector-tag { font-size: 0.68rem; font-weight: 700; color: #4338ca; background: #eef2ff; padding: 1px 6px; border-radius: 10px; margin-left: 5px; vertical-align: middle; }
.falla-bar-kg   { font-size: 0.84rem; font-weight: 700; color: var(--text-sec); white-space: nowrap; flex-shrink: 0; }
.falla-track { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
.falla-fill  { height: 100%; border-radius: 4px; background: linear-gradient(90deg,#f97316,#dc2626); }
.falla-pct-row { display: flex; gap: 16px; margin-top: 5px; font-size: 0.73rem; }
.falla-pct-prod  { color: #dc2626; font-weight: 700; }
.falla-pct-merma { color: #7c3aed; font-weight: 600; }
.falla-no-data { font-size: 0.8rem; color: var(--text-light); font-style: italic; }

@media (max-width: 768px) {
    .rank-search { width: 110px; font-size: 0.8rem; }
    .rank-search:focus { width: 130px; }
    .rank-sort { font-size: 0.78rem; }
    .rank-controls { gap: 6px; }
    .art-kpi-val { font-size: 0.88rem; }
    .art-kpi-label { font-size: 0.58rem; }
    .falla-bar-name { font-size: 0.82rem; }
    .falla-pct-row { gap: 10px; font-size: 0.69rem; }
}
@media (max-width: 400px) {
    .rank-search { width: 90px; }
    .rank-search:focus { width: 110px; }
    .art-kpi-row { gap: 5px; }
    .art-kpi { padding: 8px 5px; }
    .art-kpi-val { font-size: 0.8rem; }
}
</style>
</head>
<body class="aurora-bg">

    <!-- HEADER -->
    <header class="site-header glass-card">
        <div class="header-left">
            <img src="logo.png" alt="Nettalco" class="header-logo">
            <div>
                <h1 class="gradient-title">Ranking de Vol√∫menes Textiles</h1>
                <p class="text-muted text-sm">Nettalco - Calidad que da confianza</p>
            </div>
        </div>
        <div class="header-right">
            <span id="lastSync" class="text-muted text-sm">Cargando...</span>
        </div>
    </header>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container">

        <!-- SELECTOR DE VISTA -->
        <div class="view-selector">
            <div class="view-btn active" id="btnArticulos" onclick="switchView('articulos')">
                <span class="view-icon">üì¶</span>
                <span class="view-label">Ver Articulos</span>
                <span class="view-count" id="countArticulos">--</span>
            </div>
            <div class="view-btn" id="btnEstilos" onclick="switchView('estilos')">
                <span class="view-icon">ü§ù</span>
                <span class="view-label">Ver Estilos</span>
                <span class="view-count" id="countEstilos">--</span>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="glass-card filter-bar">
            <div class="filter-row">
                <div class="form-group">
                    <label class="form-label">Top N</label>
                    <select id="topN" class="form-select" onchange="applyFilters()">
                        <option value="10">Top 10</option>
                        <option value="20">Top 20</option>
                        <option value="50">Top 50</option>
                        <option value="100">Top 100</option>
                    </select>
                </div>
                <div class="form-group" id="clienteFilterGroup">
                    <label class="form-label">Cliente</label>
                    <select id="filterCliente" class="form-select" onchange="applyFilters()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="filter-actions">
                    <button onclick="clearFilters()" class="btn btn-secondary">Limpiar</button>
                </div>
            </div>
        </div>

        <!-- RANKING ARTICULOS -->
        <div id="panelArticulos" class="card ranking-section">
            <div class="ranking-header">
                <h2>üì¶ Articulos con Mayor Volumen</h2>
                <div class="rank-controls">
                    <select id="sortArticulos" class="rank-sort" onchange="applyFilters()">
                        <option value="volumen">‚Üì Mayor volumen</option>
                        <option value="merma">‚Üì Mayor merma %</option>
                        <option value="balance">‚öñ Balance vol+merma</option>
                    </select>
                    <input type="text" id="searchArticulos" class="rank-search" placeholder="üîç Buscar..." oninput="applyFilters()">
                    <button class="btn-expand-all" onclick="toggleAllCards()" id="btnExpandAll">+ Ver detalle</button>
                </div>
            </div>
            <div id="rankingArticulos" class="ranking-table">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- RANKING ESTILO-CLIENTE -->
        <div id="panelEstilos" class="card ranking-section hidden">
            <div class="ranking-header">
                <h2>ü§ù Estilo-Cliente con Mayor Volumen</h2>
                <div class="rank-controls">
                    <input type="text" id="searchEstilos" class="rank-search" placeholder="üîç Buscar..." oninput="applyFilters()">
                </div>
            </div>
            <div id="rankingEstiloCliente" class="ranking-table">
                <div class="spinner"></div>
            </div>
        </div>

    </div>

    <!-- FOOTER -->
    <footer class="site-footer">
        <p>Nettalco &copy; 2026 | Datos desde Oracle | Powered by Supabase</p>
    </footer>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="text-muted">Cargando datos...</p>
    </div>

<script>
// === CONFIG ===
const DATA_URL = 'https://wvxawdxfovsraatopshz.supabase.co/storage/v1/object/public/MejorIdea/rankings.json';

// === ESTADO ===
let allData = null;
let currentView = 'articulos';

// === INIT ===
document.addEventListener('DOMContentLoaded', initApp);

async function initApp() {
    showLoading();
    try {
        const resp = await fetch(DATA_URL);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        allData = await resp.json();
        renderSyncInfo();
        populateClientes();
        updateCounts();
        applyFilters();
    } catch (err) {
        console.error('Error cargando datos:', err);
        document.getElementById('lastSync').textContent = 'Error al cargar datos';
        ['rankingArticulos', 'rankingEstiloCliente'].forEach(id => {
            document.getElementById(id).innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>No se pudieron cargar los datos</p></div>';
        });
    }
    hideLoading();
}

// === CAMBIAR VISTA ===
function switchView(view) {
    currentView = view;
    document.getElementById('btnArticulos').classList.toggle('active', view === 'articulos');
    document.getElementById('btnEstilos').classList.toggle('active', view === 'estilos');
    document.getElementById('panelArticulos').classList.toggle('hidden', view !== 'articulos');
    document.getElementById('panelEstilos').classList.toggle('hidden', view !== 'estilos');
    document.getElementById('clienteFilterGroup').style.display = view === 'estilos' ? '' : 'none';
    applyFilters();
}

function renderSyncInfo() {
    const el = document.getElementById('lastSync');
    if (allData && allData.sync_date) {
        const d = new Date(allData.sync_date);
        el.textContent = `Sync: ${d.toLocaleDateString('es-PE')} ${d.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' })} (${formatNumber(allData.total_registros)} reg.)`;
    } else {
        el.textContent = 'Sin datos sincronizados';
    }
}

function populateClientes() {
    if (!allData || !allData.clientes) return;
    const select = document.getElementById('filterCliente');
    allData.clientes.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; select.appendChild(o); });
}

function updateCounts() {
    if (!allData || !allData.kpis) return;
    document.getElementById('countArticulos').textContent = formatNumber(allData.kpis.total_articulos || 0) + ' articulos';
    document.getElementById('countEstilos').textContent = formatNumber(allData.kpis.total_estilos || 0) + ' estilos';
}

// === FILTROS ===
function applyFilters() {
    if (!allData) return;
    const topN      = parseInt(document.getElementById('topN').value) || 10;
    const cliente   = document.getElementById('filterCliente').value || null;
    const sortMode  = document.getElementById('sortArticulos').value || 'volumen';
    const searchArt = (document.getElementById('searchArticulos').value || '').toLowerCase().trim();
    const searchEC  = (document.getElementById('searchEstilos').value  || '').toLowerCase().trim();

    let arts = [...allData.ranking_articulos];

    // Ordenar seg√∫n modo
    if (sortMode === 'merma') {
        arts.sort((a, b) => (b.pct_merma ?? -1) - (a.pct_merma ?? -1));
    } else if (sortMode === 'balance') {
        arts.sort((a, b) => (b.total_merma_kg ?? 0) - (a.total_merma_kg ?? 0));
    }
    // 'volumen' ‚Üí ya viene ordenado por volumen_total desde el JSON

    if (searchArt) {
        arts = arts.filter(r =>
            (r.articulo     || '').toLowerCase().includes(searchArt) ||
            (r.articulo_desc|| '').toLowerCase().includes(searchArt)
        );
    } else {
        arts = arts.slice(0, topN);
    }
    _allExpanded = false;
    const btn = document.getElementById('btnExpandAll');
    if (btn) btn.textContent = '+ Ver detalle';
    renderRanking('rankingArticulos', arts, 'articulo', 'articulo_desc', true);

    // --- Estilo-Cliente: filtrar + topN ---
    let ecs = cliente
        ? allData.ranking_estilo_cliente.filter(r => r.cliente === cliente)
        : [...allData.ranking_estilo_cliente];

    if (searchEC) {
        ecs = ecs.filter(r =>
            (r.estilo        || '').toLowerCase().includes(searchEC) ||
            (r.cliente       || '').toLowerCase().includes(searchEC) ||
            (r.estilo_cliente|| '').toLowerCase().includes(searchEC)
        );
    } else {
        ecs = ecs.slice(0, topN);
    }
    renderRanking('rankingEstiloCliente', ecs, 'estilo_cliente', null, false);
}

function clearFilters() {
    document.getElementById('topN').value = '10';
    document.getElementById('filterCliente').value = '';
    document.getElementById('sortArticulos').value = 'volumen';
    document.getElementById('searchArticulos').value = '';
    document.getElementById('searchEstilos').value = '';
    applyFilters();
}

// === RENDER ===
function renderRanking(containerId, data, nameField, descField, showMerma) {
    const container = document.getElementById(containerId);
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No hay datos disponibles</p></div>';
        return;
    }
    if (showMerma) {
        container.innerHTML = data.map((item, i) => renderArticuloCard(item, i + 1)).join('');
    } else {
        let html = '';
        data.forEach((item, i) => {
            const pos      = i + 1;
            const posClass = pos <= 3 ? `pos-${pos}` : '';
            const nombre   = item[nameField] || 'N/A';
            const desc     = descField && item[descField] ? item[descField] : '';
            const descHtml = desc ? `<span class="rank-desc">${desc}</span>` : '';
            html += `<div class="rank-row">
                <div class="rank-pos ${posClass}">${pos}</div>
                <div class="rank-name" title="${nombre}${desc ? ' - '+desc : ''}">${nombre}${descHtml}</div>
            </div>`;
        });
        container.innerHTML = html;
    }
}

function renderArticuloCard(item, pos) {
    const posClass = pos <= 3 ? `pos-${pos}` : '';
    const nombre   = item.articulo || 'N/A';
    const desc     = item.articulo_desc || '';

    // Chips superiores
    const volChip = `<span class="art-vol-chip">üì¶ ${formatNumber(item.volumen_total)} kg vol.</span>`;

    let mermaBadge = '';
    let detailHtml = '';
    const hasMerma = item.pct_merma != null;

    if (hasMerma) {
        const pct = item.pct_merma;
        const cls = pct < 1 ? 'merma-low' : pct < 3 ? 'merma-mid' : 'merma-high';
        const ico = pct < 1 ? '‚úÖ' : pct < 3 ? '‚ö†Ô∏è' : 'üî¥';
        mermaBadge = `<span class="merma-badge ${cls}">${ico} ${fmtDec(pct)}% merma</span>`;

        // KPI row
        const kpiCls = pct < 1 ? '' : pct < 3 ? 'warn' : 'danger';
        const kpiRow = `<div class="art-kpi-row">
            <div class="art-kpi">
                <div class="art-kpi-val">${formatNumber(item.total_prod_kg)}</div>
                <div class="art-kpi-label">kg producidos</div>
            </div>
            <div class="art-kpi">
                <div class="art-kpi-val ${kpiCls}">${formatNumber(item.total_merma_kg)}</div>
                <div class="art-kpi-label">kg merma</div>
            </div>
            <div class="art-kpi">
                <div class="art-kpi-val ${kpiCls}">${fmtDec(pct)}%</div>
                <div class="art-kpi-label">% de merma</div>
            </div>
        </div>`;

        // Falla progress bars
        let fallaBars = '';
        if (item.top3_mermas && item.top3_mermas.length) {
            fallaBars = '<div class="falla-section-title">Principales causas de merma:</div>';
            item.top3_mermas.forEach(f => {
                const barW = Math.min(Math.round(f.pct_merma), 100);
                fallaBars += `<div class="falla-bar-item">
                    <div class="falla-bar-header">
                        <span class="falla-bar-name">${f.falla}${f.sector ? ` <span class="falla-sector-tag">${f.sector}</span>` : ''}</span>
                        <span class="falla-bar-kg">${formatNumber(f.kilos)} kg</span>
                    </div>
                    <div class="falla-track"><div class="falla-fill" style="width:${barW}%"></div></div>
                    <div class="falla-pct-row">
                        <span class="falla-pct-prod">üî¥ ${fmtDec(f.pct_prod)}% sobre producci√≥n</span>
                        <span class="falla-pct-merma">üü£ ${fmtDec(f.pct_merma)}% de la merma</span>
                    </div>
                </div>`;
            });
        } else {
            fallaBars = '<p class="falla-no-data">Sin detalle de fallas registrado</p>';
        }
        detailHtml = `<div class="art-detail">${kpiRow}${fallaBars}</div>`;
    } else {
        detailHtml = `<div class="art-detail"><p class="falla-no-data">Sin datos de merma registrados para este art√≠culo (2025)</p></div>`;
    }

    return `<div class="art-card" id="acard-${pos}">
        <div class="art-header" onclick="toggleCard('acard-${pos}')">
            <div class="art-pos ${posClass}">${pos}</div>
            <div class="art-info">
                <div class="art-code">${nombre}</div>
                ${desc ? `<div class="art-desc">${desc}</div>` : ''}
                <div class="art-chips">${volChip}${mermaBadge}</div>
            </div>
            <span class="art-toggle">‚ñº</span>
        </div>
        ${detailHtml}
    </div>`;
}

// Expandir / colapsar una tarjeta
function toggleCard(cardId) {
    document.getElementById(cardId)?.classList.toggle('expanded');
}

// Expandir / colapsar todas
let _allExpanded = false;
function toggleAllCards() {
    _allExpanded = !_allExpanded;
    document.querySelectorAll('.art-card').forEach(c => c.classList.toggle('expanded', _allExpanded));
    document.getElementById('btnExpandAll').textContent = _allExpanded ? '‚àí Colapsar' : '+ Ver detalle';
}

// === HELPERS ===
function formatNumber(n) { return n == null ? '0' : new Intl.NumberFormat('es-PE').format(Math.round(n)); }
function fmtDec(n) { return n == null ? '--' : Number(n).toFixed(2); }
function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }

// Ocultar cliente al inicio (vista articulos por defecto)
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('clienteFilterGroup').style.display = 'none';
});
</script>

</body>
</html>
